<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>SnabbChatt - Fixad Chatt & R√∂st</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #2f3136; color: white; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .app-container { background: #36393f; width: 400px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); overflow: hidden; display: flex; flex-direction: column; position: relative; border: 1px solid #4f545c; }
        .header { padding: 15px; background: #2f3136; text-align: center; border-bottom: 1px solid #202225; }
        #display-id { font-size: 12px; color: #b9bbbe; cursor: pointer; margin-top: 5px; background: #202225; padding: 5px; border-radius: 4px; }
        #chat-box { height: 300px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: #36393f; }
        .msg { padding: 8px 12px; border-radius: 8px; font-size: 14px; max-width: 80%; word-wrap: break-word; }
        .msg.me { background: #5865f2; align-self: flex-end; color: white; }
        .msg.them { background: #4f545c; align-self: flex-start; color: white; }
        .controls { padding: 15px; background: #2f3136; border-top: 1px solid #202225; }
        .input-row { display: flex; gap: 5px; margin-bottom: 10px; }
        input { background: #202225; color: white; border: none; padding: 10px; border-radius: 5px; flex: 1; outline: none; }
        button { border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; }
        .btn-send { background: #5865f2; padding: 0 15px; }
        .btn-call { background: #43b581; width: 100%; padding: 10px; margin-top: 10px; }
        .btn-hangup { background: #ed4245; width: 100%; padding: 10px; margin-top: 10px; display: none; }
        #incoming-overlay { display: none; position: absolute; inset: 0; background: rgba(47, 49, 54, 0.98); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="incoming-overlay">
        <h2 style="color:#43b581">üìû RINGER...</h2>
        <button id="answer-btn" style="background:#43b581; width:80%; padding:15px; margin-bottom:10px;">SVARA</button>
        <button id="decline-btn" style="background:#ed4245; width:80%; padding:15px;">AVB√ñJ</button>
    </div>

    <div class="header">
        <div style="font-weight: bold;">üí¨ SNABBCHATT</div>
        <div id="display-id">H√§mtar ditt ID...</div>
    </div>

    <div id="chat-box"></div>

    <div class="controls">
        <div class="input-row">
            <input type="text" id="chat-input" placeholder="Skriv ett meddelande...">
            <button id="send-btn" class="btn-send">S√ÑND</button>
        </div>
        <input type="text" id="remote-id" placeholder="V√§nnens ID">
        <button id="call-btn" class="btn-call">üìû RING & ANSLUT</button>
        <button id="hangup-btn" class="btn-hangup">‚ùå L√ÑGG P√Ö</button>
    </div>
</div>

<audio id="remote-audio" autoplay></audio>
<audio id="sfx-ring" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>

<script>
    const peer = new Peer();
    let conn = null; 
    let currentCall = null;
    
    const chatBox = document.getElementById('chat-box');
    const chatInput = document.getElementById('chat-input');
    const ringtone = document.getElementById('sfx-ring');

    // N√§r mitt ID √§r redo
    peer.on('open', id => {
        document.getElementById('display-id').innerText = "Ditt ID: " + id;
    });

    // --- CHATT-LOGIK ---

    // Lyssna p√• inkommande CHATT-anslutning
    peer.on('connection', (connection) => {
        conn = connection;
        setupChatListeners();
    });

    function setupChatListeners() {
        conn.on('open', () => {
            addMessage("System: Ni √§r nu sammankopplade!", 'them');
        });
        conn.on('data', (data) => {
            addMessage(data, 'them');
        });
        conn.on('close', () => {
            addMessage("System: Anslutningen avbr√∂ts.", 'them');
            conn = null;
        });
    }

    function addMessage(text, side) {
        const div = document.createElement('div');
        div.className = `msg ${side}`;
        div.innerText = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Skicka meddelande
    document.getElementById('send-btn').onclick = sendMessage;
    chatInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

    function sendMessage() {
        const msg = chatInput.value;
        if (!msg) return;
        if (!conn || !conn.open) {
            // Om ingen chatt finns, prova koppla upp mot ID:t i rutan
            const id = document.getElementById('remote-id').value;
            if(id) {
                conn = peer.connect(id);
                setupChatListeners();
                // V√§nta lite p√• anslutning sen skicka
                setTimeout(() => { if(conn.open) { conn.send(msg); addMessage(msg, 'me'); } }, 500);
            } else {
                alert("Du m√•ste ansluta till n√•gon f√∂rst!");
            }
        } else {
            conn.send(msg);
            addMessage(msg, 'me');
        }
        chatInput.value = '';
    }

    // --- R√ñST-LOGIK ---

    // Inkommande samtal
    peer.on('call', (call) => {
        ringtone.play().catch(()=>{});
        document.getElementById('incoming-overlay').style.display = 'flex';

        document.getElementById('answer-btn').onclick = async () => {
            ringtone.pause();
            document.getElementById('incoming-overlay').style.display = 'none';
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            call.answer(stream);
            handleVoice(call);
        };
        
        document.getElementById('decline-btn').onclick = () => {
            ringtone.pause();
            document.getElementById('incoming-overlay').style.display = 'none';
            call.close();
        };
    });

    // Ring upp (Kopplar b√•de r√∂st och chatt)
    document.getElementById('call-btn').onclick = async () => {
        const id = document.getElementById('remote-id').value;
        if (!id) return alert("Ange ett ID!");

        // Koppla chatt
        conn = peer.connect(id);
        setupChatListeners();

        // Koppla r√∂st
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const call = peer.call(id, stream);
            handleVoice(call);
        } catch(e) { alert("Mikrofon kr√§vs!"); }
    };

    function handleVoice(call) {
        currentCall = call;
        document.getElementById('call-btn').style.display = 'none';
        document.getElementById('hangup-btn').style.display = 'block';
        
        call.on('stream', (remoteStream) => {
            document.getElementById('remote-audio').srcObject = remoteStream;
        });
        call.on('close', () => location.reload());
    }

    document.getElementById('hangup-btn').onclick = () => location.reload();

    // Kopiera ID
    document.getElementById('display-id').onclick = function() {
        const id = this.innerText.replace("Ditt ID: ", "");
        navigator.clipboard.writeText(id);
        alert("ID kopierat!");
    };
</script>
</body>
</html>
