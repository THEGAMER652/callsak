<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>SnabbChatt - Sound Effects Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #23272a; color: white; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .box { background: #2c2f33; padding: 25px; border-radius: 15px; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 15px; display: inline-block; font-weight: bold; }
        .online { background: #43b581; }
        .offline { background: #f04747; }
        input { padding: 12px; width: 85%; border-radius: 5px; border: none; margin: 10px 0; background: #202225; color: white; font-size: 16px; text-align: center; }
        
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.2s; color: white; font-size: 14px; }
        .btn-call { background: #5865f2; }
        .btn-screen { background: #43b581; display: none; }
        .btn-stop { background: #ed4245; display: none; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        #video-display { margin-top: 20px; width: 100%; display: none; border-radius: 8px; overflow: hidden; background: #000; position: relative; line-height: 0; }
        video { width: 100%; height: auto; }
        .label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 11px; z-index: 5; }
        
        select { background: #202225; color: white; padding: 10px; border-radius: 5px; width: 85%; border: 1px solid #4f545c; margin-top: 5px; }
    </style>
</head>
<body>

<div class="box">
    <div id="peer-status" class="status-badge offline">ANSLUTER...</div>
    <h2 style="margin: 0 0 5px 0;">SnabbChatt</h2>
    <p id="display-id" style="font-size: 13px; color: #b9bbbe; margin-bottom: 20px; cursor:pointer;">H√§mtar ditt ID...</p>

    <div style="text-align: left; margin-left: 7.5%;">
        <label style="font-size: 11px; color: #72767d; font-weight: bold;">MIKROFON</label><br>
        <select id="mic-select"></select>
    </div>

    <input type="text" id="remote-id" placeholder="Klistra in v√§nnens ID">
    
    <div class="btn-group">
        <button id="start-call" class="btn-call">üìû Anslut med R√∂st</button>
        <button id="start-screen" class="btn-screen">üñ•Ô∏è Dela Sk√§rm & Ljud</button>
        <button id="end-call" class="btn-stop">‚ùå L√§gg p√•</button>
    </div>

    <div id="video-display">
        <div class="label">SK√ÑRMDELNING P√ÖG√ÖR</div>
        <video id="remote-video" autoplay playsinline></video>
    </div>

    <p id="log" style="color: #faa61a; font-size: 12px; margin-top: 15px;"></p>
</div>

<audio id="remote-audio" autoplay></audio>
<audio id="sfx-join" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
<audio id="sfx-call" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
<audio id="sfx-leave" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

<script>
    const peer = new Peer();
    let myVoiceStream;
    let currentCall;
    
    const log = (m) => document.getElementById('log').innerText = m;
    const remoteVideo = document.getElementById('remote-video');
    const remoteAudio = document.getElementById('remote-audio');
    
    // SFX objekt
    const sfxJoin = document.getElementById('sfx-join');
    const sfxCall = document.getElementById('sfx-call');
    const sfxLeave = document.getElementById('sfx-leave');

    async function getVoice() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { deviceId: document.getElementById('mic-select').value } 
            });
            myVoiceStream = stream;
            return stream;
        } catch (e) {
            log("Kunde inte starta mikrofonen.");
        }
    }

    navigator.mediaDevices.enumerateDevices().then(devices => {
        const select = document.getElementById('mic-select');
        devices.filter(d => d.kind === 'audioinput').forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.text = d.label || `Mikrofon ${select.length + 1}`;
            select.appendChild(opt);
        });
    });

    peer.on('open', id => {
        document.getElementById('peer-status').innerText = "ONLINE";
        document.getElementById('peer-status').className = "status-badge online";
        document.getElementById('display-id').innerText = "Ditt ID: " + id;
    });

    // Vid inkommande samtal
    peer.on('call', async call => {
        sfxCall.play(); // B√∂rja ringa
        log("Det ringer...");
        
        if(confirm("N√•gon ringer! Vill du svara?")) {
            sfxCall.pause();
            sfxCall.currentTime = 0;
            const stream = await getVoice();
            call.answer(stream);
            setupUI(call);
            sfxJoin.play();
        } else {
            sfxCall.pause();
            call.close();
        }
    });

    document.getElementById('start-call').onclick = async () => {
        const id = document.getElementById('remote-id').value;
        if(!id) return log("Skriv in ett ID!");
        
        const stream = await getVoice();
        const call = peer.call(id, stream);
        setupUI(call);
        sfxJoin.play();
    };

    document.getElementById('start-screen').onclick = async () => {
        try {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            const id = document.getElementById('remote-id').value;
            const tracks = [...screenStream.getTracks(), ...myVoiceStream.getAudioTracks()];
            const combinedStream = new MediaStream(tracks);

            const call = peer.call(id, combinedStream);
            setupUI(call);
            
            screenStream.getVideoTracks()[0].onended = () => log("Sk√§rmdelning avslutad.");
        } catch (e) { log("Sk√§rmdelning misslyckades."); }
    };

    function setupUI(call) {
        currentCall = call;
        document.getElementById('start-call').style.display = 'none';
        document.getElementById('start-screen').style.display = 'block';
        document.getElementById('end-call').style.display = 'block';

        call.on('stream', stream => {
            if (stream.getVideoTracks().length > 0) {
                document.getElementById('video-display').style.display = 'block';
                remoteVideo.srcObject = stream;
            }
            remoteAudio.srcObject = stream;
            log("Samtal p√•g√•r");
        });

        call.on('close', () => {
            sfxLeave.play();
            setTimeout(() => location.reload(), 1000);
        });
    }

    document.getElementById('end-call').onclick = () => {
        sfxLeave.play();
        if(currentCall) currentCall.close();
        setTimeout(() => location.reload(), 500);
    };

    document.getElementById('display-id').onclick = function() {
        const id = this.innerText.split(": ")[1];
        navigator.clipboard.writeText(id);
        log("ID kopierat!");
    };
</script>
</body>
</html>
