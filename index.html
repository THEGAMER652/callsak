<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>SnabbChatt Pro - Video & Screen</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #23272a; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        .box { background: #2c2f33; padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 15px; display: inline-block; font-weight: bold; }
        .online { background: #43b581; color: white; }
        .offline { background: #f04747; color: white; }
        input { padding: 12px; width: 80%; border-radius: 5px; border: none; margin: 10px 0; background: #202225; color: white; font-size: 16px; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; color: white; }
        .btn-call { background: #5865f2; grid-column: span 2; }
        .btn-camera { background: #4f545c; }
        .btn-screen { background: #43b581; }
        .btn-stop { background: #ed4245; grid-column: span 2; display: none; }
        button:hover { opacity: 0.8; }

        #video-grid { margin-top: 20px; display: none; width: 100%; gap: 10px; flex-direction: column; }
        .video-wrapper { position: relative; width: 100%; background: #000; border-radius: 8px; overflow: hidden; line-height: 0; }
        video { width: 100%; height: auto; border-radius: 8px; }
        .label { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        
        #my-video { width: 30%; position: absolute; top: 10px; right: 10px; border: 2px solid #5865f2; z-index: 10; }
        select { background: #202225; color: white; padding: 8px; border-radius: 4px; width: 100%; margin-top: 5px; border: 1px solid #4f545c; }
    </style>
</head>
<body>

<div class="box">
    <div id="peer-status" class="status-badge offline">ANSLUTER TILL N√ÑTVERKET...</div>
    <h2 style="margin: 0 0 10px 0;">SnabbChatt Pro</h2>
    <p id="display-id" style="font-size: 14px; color: #b9bbbe; cursor: pointer;" onclick="copyID()">Klicka f√∂r att kopiera ditt ID</p>

    <div style="text-align: left; margin-bottom: 15px;">
        <label style="font-size: 11px; color: #72767d; font-weight: bold;">INPUT ENHET</label>
        <select id="mic-select"></select>
    </div>

    <input type="text" id="remote-id" placeholder="Klistra in v√§nnens ID">
    
    <div class="controls">
        <button id="start-call" class="btn-call">üìû Starta Samtal</button>
        <button id="toggle-camera" class="btn-camera" style="display:none;">üì∑ Kamera P√•/Av</button>
        <button id="start-screen" class="btn-screen" style="display:none;">üñ•Ô∏è Dela Sk√§rm</button>
        <button id="end-call" class="btn-stop">‚ùå L√§gg p√•</button>
    </div>

    <div id="video-grid">
        <div class="video-wrapper">
            <video id="remote-video" autoplay playsinline></video>
            <div class="label">V√§n</div>
            <video id="my-video" autoplay playsinline muted></video>
        </div>
    </div>

    <p id="log" style="color: #faa61a; font-size: 12px; margin-top: 15px;"></p>
</div>

<audio id="remote-audio" autoplay></audio>

<script>
    const peer = new Peer();
    let myStream;
    let currentCall;
    
    const log = (m) => document.getElementById('log').innerText = m;
    const remoteVideo = document.getElementById('remote-video');
    const myVideoDisplay = document.getElementById('my-video');

    // 1. Initiera mikrofon och kamera
    async function initMedia(video = true) {
        try {
            const constraints = { 
                audio: { deviceId: document.getElementById('mic-select').value },
                video: video 
            };
            myStream = await navigator.mediaDevices.getUserMedia(constraints);
            myVideoDisplay.srcObject = myStream;
            return myStream;
        } catch (e) {
            log("Kunde inte starta media. Kolla inst√§llningar.");
        }
    }

    // Fyll mikrofonlistan
    navigator.mediaDevices.enumerateDevices().then(devices => {
        const select = document.getElementById('mic-select');
        devices.filter(d => d.kind === 'audioinput').forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.text = d.label || `Mikrofon ${select.length + 1}`;
            select.appendChild(opt);
        });
    });

    peer.on('open', id => {
        document.getElementById('peer-status').innerText = "ONLINE";
        document.getElementById('peer-status').className = "status-badge online";
        document.getElementById('display-id').innerText = "Ditt ID: " + id;
    });

    // Svara p√• samtal
    peer.on('call', async call => {
        log("Det ringer...");
        const stream = await initMedia(true);
        call.answer(stream);
        setupCallUI(call);
    });

    // Ring upp
    document.getElementById('start-call').onclick = async () => {
        const id = document.getElementById('remote-id').value;
        if(!id) return log("Ange ID!");
        const stream = await initMedia(true);
        const call = peer.call(id, stream);
        setupCallUI(call);
    };

    // Dela sk√§rm
    document.getElementById('start-screen').onclick = async () => {
        try {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            const videoTrack = screenStream.getVideoTracks()[0];
            
            // Ers√§tt videosp√•ret i det p√•g√•ende samtalet
            const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
            sender.replaceTrack(videoTrack);
            myVideoDisplay.srcObject = screenStream;

            videoTrack.onended = () => {
                sender.replaceTrack(myStream.getVideoTracks()[0]);
                myVideoDisplay.srcObject = myStream;
            };
        } catch (e) { log("Sk√§rmdelning avbruten."); }
    };

    function setupCallUI(call) {
        currentCall = call;
        document.getElementById('video-grid').style.display = 'flex';
        document.getElementById('start-call').style.display = 'none';
        document.getElementById('toggle-camera').style.display = 'inline-block';
        document.getElementById('start-screen').style.display = 'inline-block';
        document.getElementById('end-call').style.display = 'inline-block';

        call.on('stream', stream => {
            if (stream.getVideoTracks().length > 0) {
                remoteVideo.srcObject = stream;
            } else {
                document.getElementById('remote-audio').srcObject = stream;
            }
        });
    }

    document.getElementById('end-call').onclick = () => {
        if(currentCall) currentCall.close();
        location.reload(); // Enklast p√• Vercel f√∂r att nollst√§lla P2P-sessionen
    };

    function copyID() {
        const idText = document.getElementById('display-id').innerText.replace("Ditt ID: ", "");
        navigator.clipboard.writeText(idText);
        log("ID kopierat till urklipp!");
    }
</script>
</body>
</html>
