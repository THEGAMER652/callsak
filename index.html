<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>SnabbChatt + Screenshare</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #23272a; color: white; text-align: center; padding: 20px; margin: 0; }
        .box { background: #2c2f33; padding: 20px; border-radius: 10px; display: inline-block; min-width: 350px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .status-badge { padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-bottom: 10px; display: inline-block; }
        .online { background: #43b581; }
        .offline { background: #f04747; }
        input { padding: 12px; width: 80%; border-radius: 5px; border: none; margin: 10px 0; background: #202225; color: white; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; margin: 5px; transition: 0.2s; }
        .call-btn { background: #5865f2; color: white; }
        .screen-btn { background: #43b581; color: white; display: none; }
        .stop-btn { background: #ed4245; color: white; display: none; }
        #video-container { margin-top: 20px; width: 100%; max-width: 600px; display: none; border-radius: 8px; overflow: hidden; background: black; line-height: 0; }
        video { width: 100%; height: auto; }
        select { background: #202225; color: white; padding: 5px; border-radius: 4px; border: 1px solid #4f545c; width: 80%; }
    </style>
</head>
<body>

<div class="box">
    <h2>SnabbChatt</h2>
    <div id="peer-status" class="status-badge offline">Ansluter...</div>
    <p id="display-id" style="font-weight: bold; color: #b9bbbe;">Ditt ID: väntar...</p>
    
    <hr style="border: 0.5px solid #4f545c;">
    
    <label style="font-size: 12px; color: #b9bbbe;">VÄLJ MIKROFON</label><br>
    <select id="mic-select"></select>
    
    <br><br>
    
    <input type="text" id="remote-id" placeholder="Klistra in kompisens ID">
    <br>
    <button id="start-call" class="call-btn">Anslut till rum</button>
    <button id="start-screen" class="screen-btn">Dela skärm</button>
    <button id="end-call" class="stop-btn">Lägg på</button>
    
    <div id="video-container">
        <video id="remote-video" autoplay playsinline></video>
    </div>

    <p id="log" style="color: #faa61a; font-size: 12px; margin-top: 20px;"></p>
</div>

<audio id="remote-audio" autoplay></audio>

<script>
    const logElem = document.getElementById('log');
    const statusElem = document.getElementById('peer-status');
    const startBtn = document.getElementById('start-call');
    const screenBtn = document.getElementById('start-screen');
    const stopBtn = document.getElementById('end-call');
    const videoContainer = document.getElementById('video-container');
    
    const peer = new Peer(); 
    let localStream;
    let currentCall;

    function log(msg) { logElem.innerText = msg; }

    // Fix för att hämta mikrofoner
    async function initDevices() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const devices = await navigator.mediaDevices.enumerateDevices();
            const micSelect = document.getElementById('mic-select');
            
            micSelect.innerHTML = '';
            devices.filter(d => d.kind === 'audioinput').forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || "Mikrofon " + (micSelect.length + 1);
                micSelect.appendChild(opt);
            });
            localStream = stream;
            log("Mikrofon redo.");
        } catch (err) {
            log("Kunde inte hitta mikrofon. Kolla HTTPS.");
        }
    }

    peer.on('open', (id) => {
        statusElem.innerText = "Online";
        statusElem.className = "status-badge online";
        document.getElementById('display-id').innerText = "Ditt ID: " + id;
    });

    // Hantera inkommande samtal (Svarar automatiskt med ljud)
    peer.on('call', async (call) => {
        log("Inkommande samtal...");
        call.answer(localStream);
        handleCall(call);
    });

    // Starta vanligt samtal (Ljud)
    startBtn.onclick = () => {
        const id = document.getElementById('remote-id').value;
        if(!id) return log("Ange ett ID!");
        const call = peer.call(id, localStream);
        handleCall(call);
    };

    // STARTA SCREENSHARE
    screenBtn.onclick = async () => {
        try {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            const id = document.getElementById('remote-id').value;
            
            // Om vi redan är i ett samtal, ersätt streamen eller starta nytt
            const call = peer.call(id, screenStream);
            handleCall(call);
            
            // Om användaren slutar dela skärm via webbläsarens egen knapp
            screenStream.getVideoTracks()[0].onended = () => stopCall();
        } catch (err) {
            log("Screenshare avbröts.");
        }
    };

    function handleCall(call) {
        currentCall = call;
        call.on('stream', (remoteStream) => {
            // Kolla om det är video (screenshare) eller bara ljud
            if (remoteStream.getVideoTracks().length > 0) {
                videoContainer.style.display = 'block';
                document.getElementById('remote-video').srcObject = remoteStream;
            } else {
                document.getElementById('remote-audio').srcObject = remoteStream;
            }

            startBtn.style.display = 'none';
            screenBtn.style.display = 'inline-block';
            stopBtn.style.display = 'inline-block';
            log("Ansluten!");
        });

        call.on('close', stopCall);
    }

    function stopCall() {
        if (currentCall) currentCall.close();
        document.getElementById('remote-audio').srcObject = null;
        document.getElementById('remote-video').srcObject = null;
        videoContainer.style.display = 'none';
        startBtn.style.display = 'inline-block';
        screenBtn.style.display = 'none';
        stopBtn.style.display = 'none';
        log("Samtalet avslutat.");
    }

    stopBtn.onclick = stopCall;

    initDevices();
</script>
</body>
</html>
